name: 🐧 Packer - Debian Golden Image

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'packer/debian/**'
      - 'ansible/debian/**'
      - '.github/workflows/packer-debian.yml'
  push:
    branches: [ main ]
    paths:
      - 'packer/debian/**'
      - 'ansible/debian/**'
      - '.github/workflows/packer-debian.yml'
  workflow_dispatch:

env:
  GCP_PROJECT_ID: root-cortex-465610-p8
  IMAGE_FAMILY: apache-simple

jobs:
  validate:
    name: 🔍 Validate Packer Template
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Packer
        uses: hashicorp/setup-packer@main

      - name: Validate Packer template
        run: |
          cd packer/debian
          packer init simple-apache.pkr.hcl
          packer validate simple-apache.pkr.hcl
          echo "✅ Packer template is valid"

      - name: Syntax check Ansible playbooks
        run: |
          cd ansible/debian
          ansible-playbook --syntax-check simple-playbook.yml
          echo "✅ Ansible syntax is valid"

  build:
    name: 🏗️ Build Debian Golden Image
    runs-on: ubuntu-latest
    needs: validate
    # Only build on merge to main, not on PR
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    outputs:
      image_name: ${{ steps.build.outputs.image_name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup Packer
        uses: hashicorp/setup-packer@main

      - name: Build Debian image
        id: build
        run: |
          cd packer/debian
          packer init simple-apache.pkr.hcl
          
          echo "🏗️ Building Debian golden image..."
          packer build simple-apache.pkr.hcl
          
          # Get the created image name
          IMAGE_NAME=$(gcloud compute images list \
            --filter="family=${{ env.IMAGE_FAMILY }}" \
            --sort-by="~creationTimestamp" \
            --limit=1 \
            --format="value(name)")
          
          echo "image_name=$IMAGE_NAME" >> $GITHUB_OUTPUT
          echo "✅ Built Debian image: $IMAGE_NAME"

      - name: Tag image with metadata
        run: |
          gcloud compute images add-labels ${{ steps.build.outputs.image_name }} \
            --labels=git-commit=${{ github.sha }},ci-build=true,os=debian,cis-level=2

  trigger-terraform:
    name: 🚀 Trigger Terraform Deployment
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Trigger Terraform Debian workflow
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'terraform-debian.yml',
              ref: 'main',
              inputs: {
                image_name: '${{ needs.build.outputs.image_name }}',
                triggered_by: 'packer-build',
                action: 'apply'
              }
            });
            console.log('🚀 Triggered Terraform deployment for Debian');
